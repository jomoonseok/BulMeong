<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layout/header::head('BulMeong')}"></head>
<head>
	<script>
		$(document).ready(function(){
			fn_findPw();
		});
		
		var idPass = false;
		var emailPass = false;
		
		function fn_findPw(){
			
			if(idPass == false){
				$('#id').keyup(function(){
					let idValue = $('#id').val();
					let regId = /^[0-9a-zA-Z]{6,20}$/;
					
					if(idValue != '' && regId.test(idValue) == true){
						$('#msg_id').text('');
						idPass = true;
					} else {
						$('#msg_id').text('6~20자의 소문자, 대문자, 숫자를 2개 이상 조합해야 합니다.');
						idPass = false;
						return;
					}
				});
			}
			
			if(emailPass == false){
				$('#email').keyup(function(){
					let emailValue = $('#email').val();
					let regEmail = /^[a-zA-Z0-9-_]+@[a-zA-Z0-9]+(\.[a-zA-Z]{2,}){1,2}$/;
					
					if (emailValue != '' && regEmail.test(emailValue) == true){
						$('#msg_email').text('');
						emailPass = true;
					} else {
						$('#msg_email').text('이메일 형식을 확인하세요.');
						emailPass = false;
						return;
					}
				});
			}
			
			$('#btn_findPw').click(function(){
				new Promise(function(resolve, reject){
					if($('#id').val() == '' || $('#email').val() == ''){
						reject('아이디와 이메일을 입력하세요.');
						return;
					}
					$.ajax({
						url: '/users/findPw',
						type: 'post',
						contentType: 'application/json',
						data: JSON.stringify({
							'id': $('#id').val(),
							'email': $('#email').val()
						}),
						dataType: 'json',
						success: function(resData){
							if(resData.findUser != null){
								resolve(resData.findUser);
							} else {
								reject('일치하는 회원 정보가 없습니다.');
							}
						}
					});		
				}).then(function(findUser){
					$.ajax({
						url: '/users/sendTemporaryPassword',
						type: 'post',
						data: 'id=' + findUser.id + '&email=' + findUser.email,
						dataType: 'json',
						success: function(resData){
							if(resData.isSuccess){
								alert('등록된 이메일로 임시 비밀번호가 발송되었습니다.');
								location.href = '/';
							}
						}
					});
				}).catch(function(msg){
					alert(msg);
				});
			});
		}
	</script>
</head>
<body>

	<header th:replace="~{layout/header::header_layout}"></header>
	
	<h1>비밀번호 찾기</h1>
	
	<hr>
	
	<div>
		<form>
		
			<div>
				<label for="id">
					*아이디<br>
					<input type="text" name="id" id="id">
				</label>
				<span id="msg_id"></span>
			</div>
			
			<div>
				<label for="email">
					*이메일<br>
					<input type="text" name="email" id="email">
				</label>
				<span id="msg_email"></span>
			</div>
			
			<input type="button" value="임시 비밀번호 발급" id="btn_findPw">
			<br><br>
			
			<div>
				<a th:href="@{/users/login/form}">로그인</a> / 
				<a th:href="@{/users/findId/form}">아이디 찾기</a> /
				<a th:href="@{/users/agree}">회원가입</a>
			</div>
			
		</form>
	</div>
	
</body>
</html>